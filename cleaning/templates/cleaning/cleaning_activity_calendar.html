{% extends 'base.html' %}

{% block title %}Schedule: {{ activity.activity_name }} ({{ month_name }} {{ year }}){% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3>Schedule: {{ activity.activity_name }}</h3>
  <div class="text-muted">Unit: {{ unit.get_full_location }} | Frequency: {{ activity.get_frequency_display }}</div>
    </div>
    <div>
      <a class="btn btn-outline-secondary" href="{% url 'cleaning:cleaning_activity_calendar_month' activity.pk prev_year prev_month %}">« {{ prev_month }}/{{ prev_year }}</a>
      <a class="btn btn-outline-secondary" href="{% url 'cleaning:cleaning_activity_calendar_month' activity.pk next_year next_month %}">{{ next_month }}/{{ next_year }} »</a>
      <a class="btn btn-primary" href="{% url 'cleaning:cleaning_activity_detail' activity.pk %}">Back to Activity</a>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <strong>{{ month_name }} {{ year }}</strong>
    </div>
    <div class="card-body p-0">
      <table class="table table-bordered m-0">
        <thead class="table-light">
          <tr>
            <th class="text-center">Mon</th>
            <th class="text-center">Tue</th>
            <th class="text-center">Wed</th>
            <th class="text-center">Thu</th>
            <th class="text-center">Fri</th>
            <th class="text-center">Sat</th>
            <th class="text-center">Sun</th>
          </tr>
        </thead>
        <tbody>
          {% for week in month_weeks %}
          <tr>
            {% for d in week %}
            <td class="align-top {% if not d.is_current %}bg-light text-muted{% endif %}" style="min-width: 160px; height: 140px;">
              <div class="d-flex justify-content-between">
                <div><strong>{{ d.date.day }}</strong></div>
              </div>
              {% if d.is_current %}
                {% if d.expected_slots %}
                  <div class="mt-1">
                    <span class="badge bg-info">Expected: {{ d.expected_slots|length }}</span>
                  </div>
                {% endif %}

                {% if d.existing %}
                  <div class="mt-2 small">
                    {% for r in d.existing %}
                      <div>
                        <span class="badge {% if r.status == 'VERIFIED' %}bg-primary{% elif r.status == 'COMPLETED' %}bg-success{% elif r.status == 'IN_PROGRESS' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ r.status }}</span>
                        <span class="text-muted">{{ r.scheduled_time_str }}</span>
                        <a href="{% url 'cleaning:cleaning_record_detail' r.id %}" class="ms-1">View</a>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}

                {% if d.expected_slots %}
                  <div class="mt-2">
                    {% for t in d.expected_slots %}
                      {# If no record exists at this specific time, show schedule button #}
                      {% with found=False %}
                        {% for r in d.existing %}
                          {% if r.scheduled_time_str == t %}
                            {% with found=True %}{% endwith %}
                          {% endif %}
                        {% endfor %}
                        {% if not found %}
                          <a class="btn btn-sm btn-outline-success mb-1" href="{% url 'cleaning:cleaning_record_create' %}?unit={{ unit.id }}&activity={{ activity.id }}&scheduled_date={{ d.date|date:'Y-m-d' }}&scheduled_time={{ t }}">Schedule {{ t }}</a>
                        {% endif %}
                      {% endwith %}
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="text-muted small mt-2">No scheduled work</div>
                {% endif %}
              {% endif %}
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
